== Workflow проектов базы данных инфосервиса

[.underline]#Литература:#

* Книга для понимая как работает Git - https://git-scm.com/book/ru/v2
* Интерактивный курс - https://githowto.com/ru

[.underline]#Workflow для проектов:#

* infoservice-db/is2-db (https://faktura-git.bankplus.ru/infoservice-db/is2-db)
* infoservice-db/is2-dwh (https://faktura-git.bankplus.ru/infoservice-db/is2-dwh)
* infoservice-db/is2-mtp (https://faktura-git.bankplus.ru/infoservice-db/is2-mtp)

*Получать права в gitlab'е необходимо для каждого проекта отдельно.*

[.underline]#Структура каталога (правила создания и сохранения объектов в проекте):#

* Директория deploy содержит ISDB-xxxx.sql файл. При работе нужно скопировать файл и назвать по номеру задачи.
Данный файл - это sql-инструкция установки фича задачи. Т.е. в этом файле нужно указывать вызовы создания\изменения объектов из основного хранилища объектов
(например вызов скрипта созданию вью @../src/views/example.sql). Если вы изменяете объект такой как, например, таблица,
вы не можете указать вызов создания таблицы "с нуля", поэтому вы прямо в своей копии файла ISDB-Номер.sql указываете alter table...
Или например для материализованных представлений необходимо сначала его удалить, а потом создать, следовательно в скрипте пишем drop, а потом вызов создания из хранилища.
Не забываем отделять команды между собой символом "/" в новой строке.
* Директория src содержит само хранилище объектов, где указаны объекты для их первоначального создания.
Обратите внимание, что объекты разбиты на максимально раздельный части (spec и body - разные файлы, таблица и индексы тоже разные файлы и т.д.) и могут иметь разное расширение.

[.underline]#Допустимые расширения файлов:#

* fnc - хранимые функции
* pdc - джобы
* spc - пакеты спека
* bdy - пакеты боди
* prc - хранимые процедуры
* grp - роли/схемы
* chk - ограничения
* idx - индексы
* trg - триггеры
* tps - типы спека
* tpb - типы боди
* sql - для всех остальных (операции заполнения, представления, таблицы и т.д.)

[.underline]#Схема разработки и тестирования:#

`(DESCRIPTION=(ADDRESS=(PROTOCOL=TCP)(HOST=fdbdev.ftc.ru)(PORT=1521))(CONNECT_DATA=(SERVER=DEDICATED)(SERVICE_NAME = soldier)))`

Для подключения к схемам на тестовой схеме (логин/пароль):

* IS2 - is2_test / is2_test
* DWH - is2_dwh_test / is2_dwh_test
* MTP - is2_mtp / is2_mtp

На данный момент схема разработки и тестирования является одной физической схемой, поэтому необходимо синхронизироваться с другими разработчиками и тестированием.
В дальнейшем планируется для разработки использовать отдельную схему.

[.underline]#Демо-схема:#

`(DESCRIPTION =(ADDRESS_LIST =(ADDRESS =(COMMUNITY = tcp.ftc)(PROTOCOL = TCP)(Host = dana.ftc.ru)(Port = 1526)))(CONNECT_DATA = (SID = is2_test)))`

*Демо-схема полностью в ведении эксплуатации,* используется как эталон для проката итоговой версии, поэтому выносить на нее через разработку *не предусмотрено.*

[.underline]#Схема эталон:#

`(DESCRIPTION=(ADDRESS_LIST=(ADDRESS=(COMMUNITY=tcp.ftc)(PROTOCOL=TCP)(Host=fdbdev.ftc.ru)(Port=1521)))(CONNECT_DATA=(SID=isetalon)))`

Схема эталона предназначена для установки итоговой версии, чтобы убедиться в отсутствие инвалидов. Следовательно, она должна соответствовать боевой схемы,
поэтому там можно смотреть код с боевой схемы (но все же критически места рекомендуется перезапрашивать у эксплуатации).

Для подключения к эталон схеме (логин/пароль, *регистр важен*):

* IS2 - IS2 / IS2
* DWH - DWH_OWNER / DWH_OWNER
* MTP - IS2_MTP / IS2_MTP

Ветка (бранч) *master* - соответствует коду на боевой схеме соответствующей версии, а так же предбоевым схемам, куда релиз менеджером устанавливается патч для проверки.

Ветка (бранч) *test* - сливаются все задачи, которые тестирование готово протестировать. Данная ветка после каждого merge commit'а должна быть развернута  на схему разработки.

Ветка (бранч) *RC* - фактически соответствует релиз кандидату текущей версии, в нее заливаются только те задачи, которые прошли тестирование (протестированы и закрыты) и точно должны выйти в текущую версию.


В Jira проект https://jira.ftc.ru/projects/ISDB с помощью названия версий задачи разделяются на проекты:

* просто номер - версии для задач infoservice-db/is2-db
* DWH-номер - версия для задач infoservice-db/is2-dwh
* MTP-номер - версии для задач infoservice-db/is2-mtp

Каждый проект должен выпускаться отдельной версией.

*Важно(!):* схемы is2 и mtp в основном версии устанавливаются в тех. перерыв (ночной патч). Схема dwh зачастую допускается в рабочее время (нужно смотреть на состав патча и взаимосвязи со схемой is2),
потому что в основном она используется для работы ERP и менеджеровских отчетов. Синхронизация dwh схемы и is2 происходит ежедневно в районе 7-8 утра по НСК,
поэтому в этот момент нельзя устанавливать патч и прерывать работу job'а нельзя! Время работы ERP рано утром 1го числа каждого месяца.

Конфиг файлы для подстановки значений для каждой схемы должны быть разными.

Примеры конфиг файлов (с предопределенными переменными) можно взять тут: \\pumba\WEB\Faktura\support\builds\mb\is2-db\inc\is2-defines.sql

[.underline]#Общая схема:#

* Создаем новую фича задачу от бранча RC
* Ведем разработку в своем фича бранче в рамках схемы разработки
* Заливаем в test и разворачиваем уже агрегированное с другими фичами изменения на схему тестирования

//и картинка 2
image::https://github.com/AliceMihailets/Mihailets_AM_8I7A/blob/master/image_2021-03-22_23-20-26.png?raw=true[]
image::https://img.freepik.com/free-photo/cool-geometric-triangular-figure-in-a-neon-laser-light-great-for-backgrounds-and-wallpapers_181624-9331.jpg?w=2000[alt]
